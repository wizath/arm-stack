# ARM Stack Usage Analyzer

A comprehensive tool for analyzing stack usage in ARM embedded projects. This Python-based analyzer provides detailed insights into function call graphs, stack consumption patterns, and peak memory usage estimates.

## Features

- **Comprehensive Analysis**: Analyzes object files and stack usage data to build complete call graphs
- **Visual Reports**: Color-coded output with clear categorization and formatting
- **File-based Grouping**: Organizes results by source files for better project understanding
- **Configurable Filtering**: Adjustable thresholds to focus on significant stack consumers
- **Peak Usage Estimation**: Calculates worst-case stack usage scenarios including interrupt handling
- **Symbol Resolution**: Handles complex symbol resolution across multiple object files
- **Professional Output**: Clean, readable reports suitable for documentation and code reviews

## Requirements

### System Requirements
- Python 3.6 or higher
- ARM GCC toolchain (`arm-none-eabi-objdump`)
- Project compiled with `-fstack-usage` flag

### Build System Requirements
Your project must be compiled with the `-fstack-usage` compiler flag to generate the required `.su` files:

```cmake
# CMakeLists.txt example
target_compile_options(your_target PRIVATE -fstack-usage)
```

Or for Makefile-based projects:
```makefile
CFLAGS += -fstack-usage
```

## Installation

1. Clone or download the `arm-stack` script
2. Ensure Python 3.6+ is installed
3. Make the script executable: `chmod +x arm-stack`
4. Verify ARM toolchain is available:
   ```bash
   arm-none-eabi-objdump --version
   ```

## Usage

### Basic Usage
```bash
./arm-stack <build_directory>
```

### Advanced Options
```bash
# Set custom threshold (default: 10 bytes)
./arm-stack build --threshold 50

# Disable colored output
./arm-stack build --no-color

# Suppress symbol resolution warnings
./arm-stack build --no-warnings

# Show version information
./arm-stack --version

# Combine options
./arm-stack cmake-build-debug --threshold 100 --no-warnings
```

### Command Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `build_dir` | Build directory containing object files | Required |
| `--threshold N` | Minimum stack usage threshold in bytes | 10 |
| `--no-color` | Disable colored output | False |
| `--no-warnings` | Suppress warning messages | False |

## Output Format

The analyzer generates a comprehensive report with several sections:

### 1. Stack Usage by Source File
```
main.c
  - main (1024 bytes)
  - init_system (256 bytes)
  - process_data (128 bytes)
  Total: 1408 bytes (3 functions)

stm32wlxx_hal_uart.c
  - HAL_UART_Transmit (512 bytes)
  - UART_WaitOnFlagUntilTimeout (256 bytes)
  Total: 768 bytes (2 functions)
```

### 2. Function Stack Usage Analysis
```
Flag Function Name                        Total   Frame   Depth
â”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€â”€â”€ â”€â”€â”€â”€â”€
â–¶     main                                 1024    64      15
ðŸ”„    recursive_function                   512     32      8
      helper_function                      128     24      3
```

**Legend:**
- `â–¶` Root function (entry point)
- `ðŸ”„` Recursive function
- **Total**: Frame size + maximum callee cost
- **Frame**: Local variables and call overhead
- **Depth**: Maximum call chain length

### 3. Analysis Summary
```
ðŸ“Š ANALYSIS SUMMARY
Peak execution estimate:
   Main function cost:       1024 bytes
   Worst interrupt cost:      512 bytes
   Total estimated peak:     1536 bytes

Statistics:
   Functions analyzed:         156
   Average stack usage:         45 bytes
   Maximum single function:   1024 bytes
```

## Algorithm Details

### Call Graph Construction
1. **Disassembly Parsing**: Uses `arm-none-eabi-objdump` to extract function definitions and call relationships
2. **Symbol Resolution**: Resolves function calls across object files using address mappings and symbol tables
3. **Graph Building**: Constructs directed graph representing function call relationships

### Stack Cost Calculation
1. **Frame Size Extraction**: Reads `.su` files generated by `-fstack-usage` compiler flag
2. **Recursive Traversal**: Performs depth-first traversal with cycle detection
3. **Cost Computation**: Calculates total cost as `frame_size + max(callee_costs)`
4. **Peak Estimation**: Combines main execution path with worst-case interrupt scenario

### Key Features
- **Cycle Detection**: Identifies and marks recursive functions
- **Ambiguity Handling**: Manages functions with identical names across files
- **External Function Handling**: Tracks unresolved external library calls
- **Interrupt Analysis**: Special handling for interrupt service routines

## Troubleshooting

### Common Issues

**Error: No stack usage files (.su) found**
- Ensure compilation with `-fstack-usage` flag
- Check that build completed successfully
- Verify object files exist in build directory

**Error: arm-none-eabi-objdump not found**
- Install ARM GCC toolchain
- Add toolchain to system PATH
- Verify installation: `arm-none-eabi-objdump --version`

**Warning: Ambiguous resolution**
- Multiple functions with same name across files
- Use `--no-warnings` to suppress if not critical
- Consider function name uniqueness in code

**Empty or minimal results**
- Check threshold setting (try `--threshold 1`)
- Verify object files contain debug information
- Ensure project uses standard ARM calling conventions

### Debug Tips

1. **Verify Prerequisites**: Run with verbose output to see file discovery
2. **Check Object Files**: Ensure `.o` files exist and contain symbols
3. **Validate .su Files**: Check that `.su` files are generated and contain data
4. **Test with Lower Threshold**: Use `./arm-stack build --threshold 1` to see all functions

## Comparison with avstack.pl

This tool is inspired by the original `avstack.pl` but provides several enhancements:

| Feature | avstack.pl | arm-stack |
|---------|------------|-----------|
| Language | Perl | Python 3 |
| Output Format | Plain text | Color-coded, formatted |
| File Organization | Single list | Grouped by source file |
| Filtering | Limited | Configurable thresholds |
| Error Handling | Basic | Comprehensive validation |
| Visualization | Minimal | Enhanced with icons/colors |
| Extensibility | Limited | Modular Python design |

## Contributing

Contributions are welcome! Areas for improvement:
- Additional output formats (JSON, CSV, HTML)
- Integration with build systems
- Enhanced visualization options
- Support for other architectures
- Performance optimizations for large projects

## License

MIT License - see LICENSE file for details.

## Author

Stack Analysis Tool - Professional embedded systems analysis utility. 
